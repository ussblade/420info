name: Monthly Dispensary Data Scrape

on:
  schedule:
    - cron: '0 0 1 * *'   # 1st of every month at midnight UTC
  workflow_dispatch:        # Allow manual trigger from GitHub Actions UI

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install scraper dependencies
        run: cd scraper && npm install

      - name: Run scrapers
        run: cd scraper && npm run scrape

      - name: Verify output
        run: |
          echo "=== Output file ==="
          head -20 scraper/output/dispensaries.json
          echo ""
          python3 -c "
          import json
          with open('scraper/output/dispensaries.json') as f:
              d = json.load(f)
          print(f'Total dispensaries: {d[\"count\"]}')
          "

      - name: Commit updated data files to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add scraper/output/dispensaries.json scraper/output/geocode-cache.json
          if git diff --staged --quiet; then
            echo "No changes â€” skipping commit"
          else
            git commit -m "data: update dispensaries + geocode cache [run ${{ github.run_number }}]"
            git push origin main
          fi
